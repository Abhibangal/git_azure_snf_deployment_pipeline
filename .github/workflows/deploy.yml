name: Snowflake Deployment

on:
  push:
    branches:
      - dev
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    # ----------------------------
    # Checkout repository
    # ----------------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------
    # Azure OIDC Login
    # ----------------------------
    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # ----------------------------
    # Install yq (pinned version)
    # ----------------------------
    - name: Install yq
      run: |
        set -euo pipefail
        sudo wget https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -O /usr/local/bin/yq
        sudo chmod +x /usr/local/bin/yq
        yq --version

    # ----------------------------
    # Determine Environment
    # ----------------------------
    - name: Determine Environment
      run: |
        set -euo pipefail
        if [ "${{ github.ref_name }}" = "dev" ]; then
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
        else
          echo "ENVIRONMENT=prod" >> $GITHUB_ENV
        fi

    # ----------------------------
    # Validate Database Config File Exists
    # ----------------------------
    - name: Validate Database Config File
      run: |
        set -euo pipefail
        if [ ! -f deploy_database_map.yml ]; then
          echo "deploy_database_map.yml not found in repo root!"
          exit 1
        fi

    # ----------------------------
    # Fetch Snowflake Secrets from Key Vault
    # ----------------------------
    - name: Fetch Secrets from Key Vault
      run: |
        set -euo pipefail

        SNOWFLAKE_ACCOUNT=$(az keyvault secret show \
          --vault-name kv-snowflake-deploy \
          --name SNOWFLAKEACCOUNT \
          --query value -o tsv)

        SNOWFLAKE_ROLE=$(az keyvault secret show \
          --vault-name kv-snowflake-deploy \
          --name SNOWFLAKEROLE \
          --query value -o tsv)

        SNOWFLAKE_WAREHOUSE=$(az keyvault secret show \
          --vault-name kv-snowflake-deploy \
          --name SNOWFLAKEWAREHOUSE \
          --query value -o tsv)

        if [ -z "$SNOWFLAKE_ACCOUNT" ]; then
          echo "SNOWFLAKE_ACCOUNT is empty!"
          exit 1
        fi

        if [ -z "$SNOWFLAKE_ROLE" ]; then
          echo "SNOWFLAKE_ROLE is empty!"
          exit 1
        fi

        if [ -z "$SNOWFLAKE_WAREHOUSE" ]; then
          echo "SNOWFLAKE_WAREHOUSE is empty!"
          exit 1
        fi

        echo "SNOWFLAKE_ACCOUNT=$SNOWFLAKE_ACCOUNT" >> $GITHUB_ENV
        echo "SNOWFLAKE_ROLE=$SNOWFLAKE_ROLE" >> $GITHUB_ENV
        echo "SNOWFLAKE_WAREHOUSE=$SNOWFLAKE_WAREHOUSE" >> $GITHUB_ENV

    # ----------------------------
    # Resolve Database Mapping
    # ----------------------------
    - name: Resolve Databases
      run: |
        set -euo pipefail

        for key in $(yq e '.databases | keys | .[]' deploy_database_map.yml); do
          VALUE=$(yq e ".databases.${key}.${ENVIRONMENT}" deploy_database_map.yml)

          if [ -z "$VALUE" ]; then
            echo "Missing mapping for $key in environment $ENVIRONMENT"
            exit 1
          fi

          echo "${key}=${VALUE}" >> $GITHUB_ENV
        done

    # ----------------------------
    # Login to ACR
    # ----------------------------
    - name: Login to ACR
      run: |
        set -euo pipefail
        az acr login --name acrsnowflakedeploy123

    # ----------------------------
    # Build Docker Image
    # ----------------------------
    - name: Build Docker Image
      run: |
        set -euo pipefail
        docker build -t acrsnowflakedeploy123.azurecr.io/schemachange:${{ github.sha }} .

    # ----------------------------
    # Push Docker Image
    # ----------------------------
    - name: Push Docker Image
      run: |
        set -euo pipefail
        docker push acrsnowflakedeploy123.azurecr.io/schemachange:${{ github.sha }}

    # ----------------------------
    # Update Container App Job Image
    # ----------------------------
    - name: Update Container App Job
      run: |
        set -euo pipefail
        az containerapp job update \
          --name job-snowflake-deploy \
          --resource-group rg-snowflake-deploy \
          --image acrsnowflakedeploy123.azurecr.io/schemachange:${{ github.sha }}

    # ----------------------------
    # Start Azure Container Job
    # ----------------------------
    - name: Start Azure Container Job
      run: |
        set -euo pipefail

        ENV_VARS=""

        for key in $(yq e '.databases | keys | .[]' deploy_database_map.yml); do
          VALUE=$(printenv $key)

          if [ -z "$VALUE" ]; then
            echo "Environment variable $key is missing before job start!"
            exit 1
          fi

          ENV_VARS="$ENV_VARS $key=$VALUE"
        done

        az containerapp job start \
          --name job-snowflake-deploy \
          --resource-group rg-snowflake-deploy \
          --env-vars $ENV_VARS \
                     SNOWFLAKE_ACCOUNT=$SNOWFLAKE_ACCOUNT \
                     SNOWFLAKE_ROLE=$SNOWFLAKE_ROLE \
                     SNOWFLAKE_WAREHOUSE=$SNOWFLAKE_WAREHOUSE
