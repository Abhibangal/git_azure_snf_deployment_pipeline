name: Snowflake Deployment

on:
  push:
    branches:
      - dev
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    # ----------------------------
    # Checkout repository
    # ----------------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------
    # Azure Login using OIDC
    # ----------------------------
    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # ----------------------------
    # Determine environment from branch
    # ----------------------------
    - name: Determine Environment
      run: |
        set -euo pipefail
        if [ "${{ github.ref_name }}" = "dev" ]; then
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
        else
          echo "ENVIRONMENT=prod" >> $GITHUB_ENV
        fi
        echo "Environment resolved:"

    # ----------------------------
    # Install yq (YAML parser)
    # ----------------------------
    - name: Install yq
      run: |
        set -euo pipefail
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
        sudo chmod +x /usr/local/bin/yq

    # ----------------------------
    # Resolve METADATA database from YAML
    # ----------------------------
    - name: Resolve Metadata Database
      run: |
        set -euo pipefail

        if [ ! -f deploy-database-map.yml ]; then
          echo "deploy-database-map.yml not found!"
          exit 1
        fi

        METADATA_DB=$(yq e ".databases.METADATA.${ENVIRONMENT}" deploy-database-map.yml)

        if [ -z "$METADATA_DB" ] || [ "$METADATA_DB" = "null" ]; then
          echo "Failed to resolve METADATA database!"
          exit 1
        fi

        echo "Resolved METADATA DB: $METADATA_DB"
        echo "SNOWFLAKE_DATABASE=$METADATA_DB" >> $GITHUB_ENV

    # ----------------------------
    # Login to Azure Container Registry
    # ----------------------------
    - name: Login to ACR
      run: |
        set -euo pipefail
        az acr login --name acrsnowflakedeploy123

    # ----------------------------
    # Build Docker Image
    # ----------------------------
    - name: Build Docker Image
      run: |
        set -euo pipefail
        docker build -t acrsnowflakedeploy123.azurecr.io/schemachange:${{ github.sha }} .

    # ----------------------------
    # Push Docker Image
    # ----------------------------
    - name: Push Docker Image
      run: |
        set -euo pipefail
        docker push acrsnowflakedeploy123.azurecr.io/schemachange:${{ github.sha }}

    # ----------------------------
    # Update Container App Job Image + Env Vars
    # ----------------------------
    - name: Update Container App Job
      run: |
        set -euo pipefail

        echo "Updating job with:"
        echo "ENVIRONMENT=$ENVIRONMENT"
        echo "SNOWFLAKE_DATABASE=$SNOWFLAKE_DATABASE"

        az containerapp job update \
          --name job-snowflake-deploy \
          --resource-group rg-snowflake-deploy \
          --image acrsnowflakedeploy123.azurecr.io/schemachange:${{ github.sha }} \
          --set-env-vars ENVIRONMENT=$ENVIRONMENT SNOWFLAKE_DATABASE=$SNOWFLAKE_DATABASE


    # ----------------------------
    # Start Container Job + Wait for Result
    # ----------------------------
    - name: Run Azure Container Job and Wait for Completion
      run: |
        set -euo pipefail

        JOB_NAME="job-snowflake-deploy"
        RG="rg-snowflake-deploy"

        echo "Starting container app job..."

        EXECUTION=$(az containerapp job start \
          --name $JOB_NAME \
          --resource-group $RG \
          --query name \
          -o tsv)

        echo "Execution started: $EXECUTION"

        echo "Waiting for job to finish..."

        while true; do

          STATUS=$(az containerapp job execution show \
            --name $JOB_NAME \
            --resource-group $RG \
            --job-execution-name $EXECUTION \
            --query "properties.status" \
            -o tsv)

          echo "Current status: $STATUS"

          if [ "$STATUS" = "Succeeded" ]; then
            echo "Job completed successfully"
            break
          fi

          if [ "$STATUS" = "Failed" ]; then
            echo "Job failed"
            exit 1
          fi

          if [ "$STATUS" = "Canceled" ]; then
            echo "Job canceled"
            exit 1
          fi

          sleep 20

        done